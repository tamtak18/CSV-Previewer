<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV-Previewer Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --panel-bg: #2d2d2d;
            --accent-color: #f39c12;
            --text-color: #e0e0e0;
            --border-color: #444;
            --table-header: #333;
            --table-row-even: #2a2a2a;
            --input-bg: #111;
        }

        body.light-mode {
            --bg-color: #f4f7f6;
            --panel-bg: #ffffff;
            --accent-color: #e67e22;
            --text-color: #2c3e50;
            --border-color: #dee2e6;
            --table-header: #f1f2f6;
            --table-row-even: #fafafa;
            --input-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container { max-width: 1500px; margin: 0 auto; }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }

        .logo-group { display: flex; align-items: center; }
        .logo-svg { width: 40px; height: 40px; margin-right: 15px; fill: var(--accent-color); }
        .logo-text { font-size: 1.8rem; font-weight: 800; letter-spacing: -1px; }
        .logo-text span { color: var(--accent-color); }

        .upload-section {
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .path-nav-area {
            background: var(--input-bg);
            padding: 12px 18px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--accent-color);
        }

        .path-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: var(--accent-color);
            font-family: 'Consolas', monospace;
            font-size: 0.95rem;
            outline: none;
        }

        .tabs { display: flex; overflow-x: auto; gap: 5px; }
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            font-size: 0.85rem;
            opacity: 0.7;
        }
        .tab.active { opacity: 1; border-top: 3px solid var(--accent-color); color: var(--accent-color); font-weight: bold; }

        .info-panel {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 0 8px 8px 8px;
            margin-bottom: 20px;
        }
        .info-row { display: flex; align-items: center; gap: 20px; margin-bottom: 10px; font-size: 0.85rem; }
        .info-label { color: var(--accent-color); font-weight: bold; min-width: 90px; }

        .table-wrapper {
            overflow: auto;
            max-height: 550px;
            border: 1px solid var(--border-color);
            background: var(--panel-bg);
            border-radius: 8px;
        }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; table-layout: fixed; }
        th {
            background: var(--table-header);
            color: var(--accent-color);
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 12px;
            border: 1px solid var(--border-color);
            text-align: left;
            overflow: hidden;
            white-space: nowrap;
        }

        .resizer {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 5px;
            background: transparent;
            cursor: col-resize;
            user-select: none;
        }
        .resizer:hover { background: var(--accent-color); }

        td {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            word-wrap: break-word;
            overflow-wrap: break-word;
            vertical-align: top;
        }
        tr:nth-child(even) { background-color: var(--table-row-even); }

        .btn {
            padding: 10px 18px;
            background-color: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-theme { background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); }

        .export-group {
            display: flex;
            align-items: center;
            gap: 0;
            background: var(--panel-bg);
            border: 1px solid #27ae60;
            border-radius: 5px;
            overflow: hidden;
        }

        .col-hidden { display: none !important; }
        .highlight { background-color: rgba(243, 156, 18, 0.4); }
        .hidden { display: none; }

        input[type="number"], input[type="text"], select {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <div class="logo-group">
            <svg class="logo-svg" viewBox="0 0 24 24">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M10,13L14,13V15H10V13M10,17L14,17V19H10V17M10,9L14,9V11H10V9Z" />
            </svg>
            <div class="logo-text">CSV-<span>Previewer</span></div>
        </div>
        <button class="btn btn-theme" onclick="toggleTheme()">THEME 切り替え</button>
    </header>

    <div class="upload-section">
        <input type="file" id="fileInput" accept=".csv" multiple />
        <span style="font-size: 0.8rem; opacity: 0.6;">Select CSV files to preview.</span>
    </div>

    <div id="pathNavArea" class="path-nav-area hidden">
        <button class="btn" style="padding:4px 10px; background:#555" onclick="modifyPathLevel(-1)">↑ Back</button>
        <input type="text" id="pathInput" class="path-input" onchange="manualPathUpdate()">
    </div>

    <div id="tabContainer" class="tabs"></div>
    
    <div id="infoPanel" class="info-panel hidden">
        <div class="info-row">
            <span class="info-label">RECORDS:</span> <span id="recordCount">--</span>
            <span class="info-label" style="margin-left: 30px;">FILE SIZE:</span> <span id="fileSize">--</span>
            <span class="info-label" style="margin-left: 30px;">DISPLAY:</span> <span id="rangeDisplay">--</span>
        </div>
        <div id="columnManager" class="info-row hidden" style="background: rgba(231, 76, 60, 0.1); padding: 5px; border-radius: 4px;">
            <span class="info-label" style="color:#e74c3c">HIDDEN:</span>
            <div id="hiddenList"></div>
        </div>
    </div>

    <div id="mainContent" class="hidden">
        <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center; flex-wrap:wrap;">
            <button class="btn" style="background:#555" onclick="jumpTo(0)">TOP</button>
            <button class="btn" style="background:#555" onclick="movePage(-50)">PREV</button>
            <input type="number" id="startRow" value="0" style="width: 80px;">
            <button class="btn" onclick="loadCurrentTabCsv()">GOTO</button>
            <button class="btn" style="background:#555" onclick="movePage(50)">NEXT</button>
            <button class="btn" style="background:#555" onclick="jumpToLast()">END</button>
            <div style="flex-grow:1"></div>
            <input type="text" id="searchInput" placeholder="Search..." oninput="searchInTable()">
            
            <div class="export-group">
                <select id="exportScope" style="border:none; height:100%; border-radius:0; background:#2c3e50; color:white; padding: 0 10px;">
                    <option value="view">表示範囲のみ</option>
                    <option value="all">全レコード (⚠️容量注意)</option>
                </select>
                <button class="btn" style="background:#27ae60; border-radius:0;" onclick="handleExport()">EXCEL EXPORT</button>
            </div>
        </div>

        <div class="table-wrapper">
            <table id="dataTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let filesData = {}; 
    let activeFileId = null;

    function toggleTheme() { document.body.classList.toggle('light-mode'); }

    document.getElementById('fileInput').addEventListener('change', (e) => {
        Array.from(e.target.files).filter(f => f.name.endsWith('.csv')).forEach(file => {
            const fileId = "id_" + Math.random().toString(36).substr(2, 9);
            filesData[fileId] = {
                file: file, 
                sizeBytes: file.size,
                fullPathStr: `./output/${file.name}`, 
                currentPathStr: `./output/${file.name}`,
                startRow: 0, totalRows: 0, hiddenColumns: new Set(), headers: [], currentData: []
            };
            countTotalRows(fileId);
            createTab(fileId, file.name);
            switchTab(fileId);
        });
    });

    function countTotalRows(id) {
        let count = 0;
        Papa.parse(filesData[id].file, { worker: true, step: () => { count++; }, complete: () => {
            filesData[id].totalRows = count - 1;
            if (activeFileId === id) updateInfoDisplay();
        }});
    }

    function createTab(id, name) {
        const tab = document.createElement('div');
        tab.className = 'tab'; tab.id = 'tab_' + id;
        tab.innerHTML = `${name} <span onclick="closeTab(event, '${id}')" style="margin-left:10px;color:#e74c3c">×</span>`;
        tab.onclick = () => switchTab(id);
        document.getElementById('tabContainer').appendChild(tab);
    }

    function switchTab(id) {
        activeFileId = id;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab_' + id).classList.add('active');
        const fData = filesData[id];
        document.getElementById('startRow').value = fData.startRow;
        document.getElementById('pathInput').value = fData.currentPathStr;
        document.getElementById('pathNavArea').classList.remove('hidden');
        document.getElementById('infoPanel').classList.remove('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        loadCurrentTabCsv();
    }

    function loadCurrentTabCsv() {
        const fData = filesData[activeFileId];
        fData.startRow = parseInt(document.getElementById('startRow').value) || 0;
        let rowCount = 0; let dataRows = [];
        Papa.parse(fData.file, {
            header: true, skipEmptyLines: true, dynamicTyping: true,
            step: function(results, parser) {
                if (rowCount >= fData.startRow && rowCount < fData.startRow + 50) dataRows.push(results.data);
                if (rowCount >= fData.startRow + 50) parser.abort();
                rowCount++;
            },
            complete: function() {
                fData.currentData = dataRows;
                if (dataRows.length > 0) {
                    fData.headers = Object.keys(dataRows[0]);
                    renderTable();
                    updateInfoDisplay();
                }
            }
        });
    }

    function renderTable() {
        const fData = filesData[activeFileId];
        const head = document.getElementById('tableHead');
        const body = document.getElementById('tableBody');
        head.innerHTML = ''; body.innerHTML = '';

        const trH = document.createElement('tr');
        fData.headers.forEach((h, idx) => {
            const th = document.createElement('th');
            th.innerHTML = `${h}<div class="resizer"></div>`;
            if (fData.hiddenColumns.has(idx)) th.classList.add('col-hidden');
            th.onclick = (e) => { if(!e.target.classList.contains('resizer')) toggleColumn(idx); };
            initResizer(th);
            trH.appendChild(th);
        });
        head.appendChild(trH);

        fData.currentData.forEach(row => {
            const tr = document.createElement('tr');
            fData.headers.forEach((h, idx) => {
                const td = document.createElement('td');
                td.textContent = row[h] ?? '';
                if (fData.hiddenColumns.has(idx)) td.classList.add('col-hidden');
                tr.appendChild(td);
            });
            body.appendChild(tr);
        });
    }

    function initResizer(th) {
        const resizer = th.querySelector('.resizer');
        let startX, startWidth;
        resizer.addEventListener('mousedown', e => {
            startX = e.pageX; startWidth = th.offsetWidth;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
        function onMouseMove(e) { th.style.width = startWidth + (e.pageX - startX) + 'px'; }
        function onMouseUp() { document.removeEventListener('mousemove', onMouseMove); }
    }

    function toggleColumn(index) {
        const fData = filesData[activeFileId];
        if (fData.hiddenColumns.has(index)) fData.hiddenColumns.delete(index);
        else fData.hiddenColumns.add(index);
        renderTable(); updateInfoDisplay();
    }

    function updateInfoDisplay() {
        const fData = filesData[activeFileId];
        document.getElementById('recordCount').textContent = fData.totalRows.toLocaleString();
        
        const mbSize = (fData.sizeBytes / (1024 * 1024)).toFixed(2);
        document.getElementById('fileSize').textContent = mbSize + " MB";
        
        document.getElementById('rangeDisplay').textContent = `${fData.startRow} - ${fData.startRow + 50}`;
        const manager = document.getElementById('columnManager');
        const list = document.getElementById('hiddenList');
        if (fData.hiddenColumns.size > 0) {
            manager.classList.remove('hidden');
            list.innerHTML = Array.from(fData.hiddenColumns).map(idx => 
                `<span onclick="toggleColumn(${idx})" style="background:#e74c3c;color:#fff;padding:2px 8px;border-radius:10px;margin-right:5px;cursor:pointer">${fData.headers[idx]}</span>`
            ).join('');
        } else manager.classList.add('hidden');
    }

    /* 水際対策を導入したエクスポート・ハンドラ */
    function handleExport() {
        const fData = filesData[activeFileId];
        const scope = document.getElementById('exportScope').value;
        const sizeLimitWarn = 500 * 1024 * 1024; // 500MB
        const sizeLimitBlock = 1.5 * 1024 * 1024 * 1024; // 1.5GB

        if (scope === 'all') {
            if (fData.sizeBytes > sizeLimitBlock) {
                alert(`⚠️ ファイルサイズが ${ (fData.sizeBytes / (1024**3)).toFixed(2) } GB と非常に巨大です．\nブラウザがクラッシュするのを防ぐため，全件エクスポートを停止しました．\n「表示範囲のみ」をご利用ください．`);
                return;
            }
            if (fData.sizeBytes > sizeLimitWarn) {
                const proceed = confirm(`⚠️ ファイルサイズが 500MB を超えています．\nExcel変換には膨大なメモリを消費し，ブラウザがフリーズしたり落ちたりする可能性があります．\n続行しますか？`);
                if (!proceed) return;
            }
        }
        
        // 実際の処理へ
        executeExport(scope, fData);
    }

    function executeExport(scope, fData) {
        const visibleHeaderIdx = fData.headers.map((h, i) => fData.hiddenColumns.has(i) ? null : i).filter(v => v !== null);

        if (scope === 'view') {
            processExport(fData.currentData, visibleHeaderIdx, fData.headers);
        } else {
            Papa.parse(fData.file, {
                header: true, skipEmptyLines: true, dynamicTyping: true,
                complete: function(results) {
                    processExport(results.data, visibleHeaderIdx, fData.headers);
                }
            });
        }
    }

    function processExport(data, visibleIdx, allHeaders) {
        const exportData = data.map(row => {
            let filtered = {};
            visibleIdx.forEach(idx => {
                const h = allHeaders[idx];
                filtered[h] = row[h];
            });
            return filtered;
        });
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Export");
        XLSX.writeFile(wb, `${filesData[activeFileId].file.name.split('.')[0]}_export.xlsx`);
    }

    function movePage(step) { document.getElementById('startRow').value = Math.max(0, parseInt(document.getElementById('startRow').value) + step); loadCurrentTabCsv(); }
    function jumpTo(row) { document.getElementById('startRow').value = row; loadCurrentTabCsv(); }
    function jumpToLast() { jumpTo(Math.max(0, filesData[activeFileId].totalRows - 50)); }
    function searchInTable() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('#tableBody td').forEach(c => {
            if (q && c.textContent.toLowerCase().includes(q)) c.classList.add('highlight');
            else c.classList.remove('highlight');
        });
    }
    function manualPathUpdate() { filesData[activeFileId].currentPathStr = document.getElementById('pathInput').value; }
    function closeTab(e, id) { e.stopPropagation(); delete filesData[id]; document.getElementById('tab_'+id).remove(); if(activeFileId===id) location.reload(); }
</script>
</body>
</html>