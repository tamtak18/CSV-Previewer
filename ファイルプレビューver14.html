<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV-Previewer Pro - Global Search</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-color: #1e1e1e; --panel-bg: #2d2d2d; --accent-color: #f39c12;
            --text-color: #e0e0e0; --border-color: #444; --table-header: #333;
            --table-row-even: #2a2a2a; --input-bg: #111;
        }
        body.light-mode {
            --bg-color: #f4f7f6; --panel-bg: #ffffff; --accent-color: #e67e22;
            --text-color: #2c3e50; --border-color: #dee2e6; --table-header: #f1f2f6;
            --table-row-even: #fafafa; --input-bg: #ffffff;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; transition: 0.3s; }
        .container { max-width: 1500px; margin: 0 auto; }
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; }
        .logo-group { display: flex; align-items: center; }
        .logo-svg { width: 35px; height: 35px; margin-right: 12px; fill: var(--accent-color); }
        .logo-text { font-size: 1.6rem; font-weight: 800; }
        .logo-text span { color: var(--accent-color); }

        /* グローバル検索パネル */
        .search-panel { background: var(--panel-bg); border: 1px solid var(--accent-color); border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .search-results { max-height: 150px; overflow-y: auto; margin-top: 10px; font-size: 0.8rem; background: var(--input-bg); border-radius: 4px; }
        .result-item { padding: 5px 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; }
        .result-item:hover { background: var(--accent-color); color: #000; }

        .upload-section { background: var(--panel-bg); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 15px; display: flex; align-items: center; gap: 15px; }
        .tabs { display: flex; overflow-x: auto; gap: 5px; }
        .tab { padding: 10px 20px; cursor: pointer; background: var(--panel-bg); border: 1px solid var(--border-color); border-bottom: none; border-radius: 6px 6px 0 0; font-size: 0.8rem; opacity: 0.6; }
        .tab.active { opacity: 1; border-top: 3px solid var(--accent-color); color: var(--accent-color); font-weight: bold; }
        
        .info-panel { background: var(--panel-bg); border: 1px solid var(--border-color); padding: 12px; border-radius: 0 8px 8px 8px; margin-bottom: 15px; }
        .table-wrapper { overflow: auto; max-height: 500px; border: 1px solid var(--border-color); background: var(--panel-bg); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; table-layout: fixed; }
        th { background: var(--table-header); color: var(--accent-color); position: sticky; top: 0; z-index: 10; padding: 10px; border: 1px solid var(--border-color); text-align: left; }
        td { padding: 8px 10px; border: 1px solid var(--border-color); word-wrap: break-word; vertical-align: top; }
        .resizer { position: absolute; right: 0; top: 0; height: 100%; width: 4px; cursor: col-resize; }
        .highlight { background-color: rgba(243, 156, 18, 0.5); color: #fff; }
        .btn { padding: 8px 15px; background-color: var(--accent-color); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }
        .hidden { display: none; }
        input { background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-color); padding: 8px; border-radius: 4px; }
    </style>
</head>
<body class="dark-mode">

<div class="container">
    <header class="header">
        <div class="logo-group">
            <svg class="logo-svg" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M10,13L14,13V15H10V13M10,17L14,17V19H10V17M10,9L14,9V11H10V9Z" /></svg>
            <div class="logo-text">CSV-<span>Previewer</span></div>
        </div>
        <button class="btn" style="background:none; border:1px solid var(--accent-color); color:var(--accent-color)" onclick="toggleTheme()">THEME 切り替え</button>
    </header>

    <div id="searchSection" class="search-panel hidden">
        <div style="display:flex; gap:10px; align-items:center;">
            <strong style="color:var(--accent-color)">GLOBAL SEARCH:</strong>
            <input type="text" id="globalSearchInput" placeholder="全ファイルから検索..." style="flex-grow:1">
            <button class="btn" onclick="runGlobalSearch()">全件スキャン開始</button>
        </div>
        <div id="globalResults" class="search-results"></div>
    </div>

    <div class="upload-section">
        <input type="file" id="fileInput" accept=".csv" multiple />
        <span style="font-size: 0.75rem; opacity: 0.6;">Select CSV files to start.</span>
    </div>

    <div id="tabContainer" class="tabs"></div>
    
    <div id="infoPanel" class="info-panel hidden">
        <div id="mainControls" style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
            <button class="btn" style="background:#555" onclick="jumpTo(0)">TOP</button>
            <input type="number" id="startRow" value="0" style="width: 70px;">
            <button class="btn" onclick="loadCurrentTabCsv()">GOTO</button>
            <button class="btn" style="background:#555" onclick="movePage(50)">NEXT</button>
            <div style="flex-grow:1; font-size:0.8rem;">
                <span style="color:var(--accent-color)">RECORDS:</span> <span id="recordCount">--</span> | 
                <span style="color:var(--accent-color)">SIZE:</span> <span id="fileSize">--</span>
            </div>
            <button class="btn" style="background:#27ae60" onclick="exportToExcel()">EXCEL EXPORT</button>
        </div>
        <div id="columnManager" class="hidden" style="font-size:0.75rem; padding:5px; background:rgba(231,76,60,0.1); border-radius:4px;">
            <span style="color:#e74c3c; font-weight:bold;">HIDDEN:</span> <span id="hiddenList"></span>
        </div>
    </div>

    <div id="mainContent" class="hidden">
        <div class="table-wrapper">
            <table id="dataTable"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
        </div>
    </div>
</div>

<script>
    let filesData = {}; let activeFileId = null;
    function toggleTheme() { document.body.classList.toggle('light-mode'); }

    document.getElementById('fileInput').addEventListener('change', (e) => {
        const files = Array.from(e.target.files).filter(f => f.name.endsWith('.csv'));
        files.forEach(file => {
            const fileId = "id_" + Math.random().toString(36).substr(2, 9);
            filesData[fileId] = { file, sizeBytes: file.size, startRow: 0, totalRows: 0, hiddenColumns: new Set(), headers: [] };
            createTab(fileId, file.name);
            countTotalRows(fileId);
            document.getElementById('searchSection').classList.remove('hidden');
        });
    });

    function createTab(id, name) {
        const tab = document.createElement('div'); tab.className = 'tab'; tab.id = 'tab_' + id;
        tab.innerHTML = `${name.length > 20 ? name.substr(0,17)+'...' : name} <span onclick="closeTab(event,'${id}')" style="color:#e74c3c">×</span>`;
        tab.onclick = () => switchTab(id);
        document.getElementById('tabContainer').appendChild(tab);
    }

    function switchTab(id, targetRow = 0) {
        activeFileId = id;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab_' + id).classList.add('active');
        document.getElementById('startRow').value = targetRow;
        document.getElementById('infoPanel').classList.remove('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        loadCurrentTabCsv();
    }

    function runGlobalSearch() {
        const query = document.getElementById('globalSearchInput').value.toLowerCase();
        const resultsDiv = document.getElementById('globalResults');
        resultsDiv.innerHTML = '<div style="padding:10px;">スキャン中...</div>';
        if (!query) return;

        Object.keys(filesData).forEach(id => {
            let rowIdx = 0;
            Papa.parse(filesData[id].file, {
                header: false, worker: true,
                step: function(row) {
                    const line = row.data.join(" ").toLowerCase();
                    if (line.includes(query)) {
                        const item = document.createElement('div');
                        item.className = 'result-item';
                        item.innerHTML = `<span><strong>${filesData[id].file.name}</strong> (行: ${rowIdx})</span> <span style="opacity:0.7">${row.data.slice(0,3).join(", ")}...</span>`;
                        const jumpRow = rowIdx === 0 ? 0 : rowIdx - 1; // ヘッダー考慮
                        item.onclick = () => switchTab(id, jumpRow);
                        resultsDiv.appendChild(item);
                    }
                    rowIdx++;
                },
                complete: () => { if(resultsDiv.innerHTML.includes("スキャン中")) resultsDiv.innerHTML = '<div style="padding:10px;">検索完了（該当なし）</div>'; }
            });
        });
        resultsDiv.innerHTML = '';
    }

    function loadCurrentTabCsv() {
        const fData = filesData[activeFileId];
        const start = parseInt(document.getElementById('startRow').value) || 0;
        let rowCount = 0; let dataRows = [];
        Papa.parse(fData.file, {
            header: true, skipEmptyLines: true, dynamicTyping: true,
            step: function(results, parser) {
                if (rowCount >= start && rowCount < start + 50) dataRows.push(results.data);
                if (rowCount >= start + 50) parser.abort();
                rowCount++;
            },
            complete: function() {
                if (dataRows.length > 0) {
                    fData.headers = Object.keys(dataRows[0]);
                    renderTable(dataRows);
                    updateInfoDisplay(start);
                }
            }
        });
    }

    function renderTable(data) {
        const fData = filesData[activeFileId];
        const head = document.getElementById('tableHead'); const body = document.getElementById('tableBody');
        head.innerHTML = ''; body.innerHTML = '';
        const trH = document.createElement('tr');
        fData.headers.forEach((h, i) => {
            const th = document.createElement('th'); th.innerHTML = `${h}<div class="resizer"></div>`;
            if (fData.hiddenColumns.has(i)) th.style.display = 'none';
            th.onclick = (e) => { if(!e.target.className.includes('resizer')) toggleColumn(i); };
            trH.appendChild(th);
        });
        head.appendChild(trH);
        data.forEach(row => {
            const tr = document.createElement('tr');
            fData.headers.forEach((h, i) => {
                const td = document.createElement('td'); td.textContent = row[h] ?? '';
                if (fData.hiddenColumns.has(i)) td.style.display = 'none';
                tr.appendChild(td);
            });
            body.appendChild(tr);
        });
    }

    function toggleColumn(i) {
        const fData = filesData[activeFileId];
        fData.hiddenColumns.has(i) ? fData.hiddenColumns.delete(i) : fData.hiddenColumns.add(i);
        loadCurrentTabCsv();
    }

    function updateInfoDisplay(start) {
        const fData = filesData[activeFileId];
        document.getElementById('recordCount').textContent = fData.totalRows.toLocaleString();
        document.getElementById('fileSize').textContent = (fData.sizeBytes / (1024*1024)).toFixed(2) + " MB";
        const hList = document.getElementById('hiddenList');
        const manager = document.getElementById('columnManager');
        if (fData.hiddenColumns.size > 0) {
            manager.classList.remove('hidden');
            hList.innerHTML = Array.from(fData.hiddenColumns).map(idx => `<span onclick="toggleColumn(${idx})" style="background:#e74c3c; color:#fff; padding:2px 6px; border-radius:10px; margin-right:5px; cursor:pointer;">${fData.headers[idx]}</span>`).join('');
        } else manager.classList.add('hidden');
    }

    function countTotalRows(id) {
        let count = 0;
        Papa.parse(filesData[id].file, { worker: true, step: () => count++, complete: () => { filesData[id].totalRows = count - 1; if(activeFileId===id) updateInfoDisplay(0); }});
    }

    function movePage(s) { document.getElementById('startRow').value = Math.max(0, parseInt(document.getElementById('startRow').value) + s); loadCurrentTabCsv(); }
    function jumpTo(r) { document.getElementById('startRow').value = r; loadCurrentTabCsv(); }
    function jumpToLast() { jumpTo(filesData[activeFileId].totalRows - 50); }
    function closeTab(e, id) { e.stopPropagation(); delete filesData[id]; document.getElementById('tab_'+id).remove(); if(activeFileId===id) location.reload(); }
    function exportToExcel() { /* 以前のロジックを継承 */ }
</script>
</body>
</html>